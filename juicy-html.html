<!--
juicy-html.html
(c) 2013-2015 Juicy
MIT license
https://github.com/Juicy/juicy-html
version: 1.2.0
-->
<script>
    (function(scope) {
        class JuicyHTMLElement extends HTMLTemplateElement {
            static get observedAttributes() {return ['model', 'content']; }
            constructor(self){
                self = super(self);
                self.create();
            }
            connectedCallback(){
                this.isAttached = true;
                this.loadTemplate_();
            }
            disconnectedCallback(){
                this.isAttached = false;
                this.clear();
            }
        };
        var JuicyHTMLPrototype = JuicyHTMLElement.prototype;
        var isSafari = navigator.vendor && navigator.vendor.indexOf("Apple") > -1 && navigator.userAgent && !navigator.userAgent.match("CriOS");

        JuicyHTMLPrototype.create = function() {
            var model = null;
            Object.defineProperty(this, "model", {
                set: function(newValue) {
                    model = newValue;
                    this.attachModel(newValue);
                },
                get: function() {
                    return model;
                }
            });
        };
        /**
         * Reference to pending request
         * @type {XMLHttpRequest}
         */
        JuicyHTMLPrototype.pending = null;

        JuicyHTMLPrototype.stampedNodes = null;
        JuicyHTMLPrototype.loadTemplate_ = function() {
            // skip pending request
            this.skipStampingPendingFile();
            var val = this.getAttribute('content');
            if (val && (val.indexOf('/') === 0 || val.indexOf('./') === 0 || val.indexOf('../') === 0)) {
                //val is a URL, load the partial from external file
                this._loadExternalFile(val);
            } else if (val === null) {
                this.clear();
            } else {
                //val is HTML code, insert the partial from the string
                this.reattachTemplate_(val);
            }
        };
        /**
         * Skips/disregards pending request if any.
         */
        JuicyHTMLPrototype.skipStampingPendingFile = function() {
            if(this.pending){
                this.pending.onload = null;
            }
        };
        /**
         * Load the partial from the HTTP server/cache, via XHR.
         * @param  {String} url relative/absolute string to load the resource
         * @return {HTMLElement}     itself
         */
        JuicyHTMLPrototype._loadExternalFile = function(url){
            var oReq = new XMLHttpRequest();
            var that = this;
            this.pending = oReq;
            oReq.onload = function(event) {
                that.pending = null;
                that.reattachTemplate_(event.target.responseText, oReq.status);
            };
            oReq.open("GET", url, true);
            oReq.send();
        };

        JuicyHTMLPrototype.reattachTemplate_ = function(html, statusCode) {
            this.clear();
            if(html === ''){
                if(statusCode === 204){
                    console.info('no content was returned for juicy-html (', this, ')');
                } else {
                    console.warn('content given for juicy-html (', this, ') is an empty file');
                }
            }
            // fragmentFromString(strHTML) from http://stackoverflow.com/a/25214113/868184
            var range = document.createRange();

            // Safari does not support `createContextualFragment` without selecting a node.
            if (isSafari) {
                range.selectNode(this);
            }

            var fragment = range.createContextualFragment(html);
            // convert dynamic NodeList to regullar array
            this.stampedNodes = Array.prototype.slice.call(fragment.childNodes);
            // attach models
            this.attributeChangedCallback("model", undefined, this.model || this.getAttribute("model"));
            this.parentNode.insertBefore(fragment, this.nextSibling);
            this.dispatchEvent(new CustomEvent("stamped", {
                detail: this.stampedNodes
            }));

        };

        /**
         * Remove stamped content.
         */
        JuicyHTMLPrototype.clear = function() {
            var parent = this.parentNode;
            var childNo = this.stampedNodes && this.stampedNodes.length || 0;
            var child;
            while (childNo--) {
                // this.stampedNodes[childNo].remove();
                child = this.stampedNodes[childNo];
                if (child.parentNode) {
                    child.parentNode.removeChild(child);
                }
            }
            // forget the removed nodes
            this.stampedNodes = null;
        };

        JuicyHTMLPrototype.isAttached = false;
        JuicyHTMLPrototype.attributeChangedCallback = function(name, oldVal, newVal) {
            if (this.isAttached) {
                switch (name) {
                    case "model":
                        if (typeof newVal === "string") {
                            newVal = newVal ? JSON.parse(newVal) : null;
                        }
                        this.model = newVal;
                        break;
                    case "content":
                        this.loadTemplate_();
                        break;
                }
            }
            /* even though it usually doesn't make sense to dispatch an event for a change coming from the outside, 
            this time it does. Because attributeChangedCallback is asynchronous (due to the polyfill) and we need to know when it was actually called */
            this.dispatchEvent(new CustomEvent('attribute-changed', {name, value: newVal}));
        };

        JuicyHTMLPrototype.attachModel = function(model, arrayOfElements) {
            arrayOfElements || (arrayOfElements = this.stampedNodes);
            if (model === null || !arrayOfElements) {
                return;
            }
            for (var childNo = 0; childNo < arrayOfElements.length; childNo++) {
                arrayOfElements[childNo].model = model;
            }
        };

        scope.JuicyHTMLElement = JuicyHTMLElement
        customElements.define('juicy-html', JuicyHTMLElement, {extends: 'template'});
    })(window);
</script>
